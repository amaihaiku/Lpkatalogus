<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#121212" />
  <title>LP Katal√≥gus</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='96' fill='%23121212'/%3E%3Ccircle cx='96' cy='96' r='72' fill='none' stroke='%23d4af37' stroke-width='12'/%3E%3Ccircle cx='96' cy='96' r='14' fill='%23d4af37'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#121212; --card:#1e1e1e; --text:#e0e0e0; --muted:#a6a6a6; --gold:#d4af37;
      --danger:#ff5b5b; --ok:#39d98a; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.45);
      --navH:72px; --maxW:980px; --focus:0 0 0 3px rgba(212,175,55,.28);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}

    /* Fekv≈ë m√≥d overlay */
    #landscapeOverlay{
      display:none;position:fixed;inset:0;z-index:9999;
      background:var(--bg);
      align-items:center;justify-content:center;flex-direction:column;gap:24px;
    }
    #landscapeOverlay p{margin:0;font-size:15px;color:var(--muted);text-align:center;max-width:260px;line-height:1.6}
    @media (orientation:landscape) and (max-width:900px){
      #landscapeOverlay{display:flex !important;}
    }

    .app{min-height:100vh;padding-bottom:calc(var(--navH) + env(safe-area-inset-bottom));display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxW);padding:18px 16px 22px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 4px 6px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--gold);box-shadow:0 0 22px rgba(212,175,55,.65)}
    .brand h1{margin:0;font-size:16px;letter-spacing:.12em;text-transform:uppercase;font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:var(--muted);font-size:12px;user-select:none}
    .pill strong{color:var(--text);font-weight:600}
    .hidden{display:none !important}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .section{margin-top:14px;padding:16px}
    .section h2{margin:0 0 10px 0;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:700}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    button{appearance:none;border:0;cursor:pointer;border-radius:14px;padding:12px 14px;font-weight:700;letter-spacing:.02em;color:var(--bg);background:var(--gold);box-shadow:0 10px 22px rgba(212,175,55,.15)}
    button:focus-visible{outline:none;box-shadow:var(--shadow),var(--focus)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(212,175,55,.35);box-shadow:none}
    .btn-muted{background:rgba(255,255,255,.06);color:var(--text);box-shadow:none}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:none}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.22);color:var(--text);outline:none}
    input:focus,select:focus{box-shadow:var(--focus);border-color:rgba(212,175,55,.5)}
    select option{background:#1e1e1e;color:var(--text)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}

    .startup{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - var(--navH) - 100px);padding:22px 10px;gap:18px}
    .vinyl{width:220px;height:220px;position:relative;border-radius:50%;background:
      radial-gradient(circle at 50% 50%, rgba(212,175,55,.95) 0 8px, transparent 9px),
      radial-gradient(circle at 50% 50%, rgba(0,0,0,.0) 0 40px, rgba(0,0,0,.45) 41px),
      radial-gradient(circle at 50% 50%, #101010 0 46%, #0b0b0b 60%, #141414 70%, #0a0a0a 100%);
      box-shadow:0 28px 60px rgba(0,0,0,.6),0 0 40px rgba(212,175,55,.08);border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .vinyl:before{content:"";position:absolute;inset:-2px;border-radius:50%;
      background:repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.05) 0 1px, rgba(255,255,255,0) 2px 10px);
      mix-blend-mode:overlay;opacity:.6}
    .vinyl:after{content:"";position:absolute;width:52px;height:52px;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:50%;
      background:radial-gradient(circle,#d4af37 0 10px,#161616 11px 100%);border:1px solid rgba(255,255,255,.08);box-shadow:0 0 18px rgba(212,175,55,.25)}
    .startup p{margin:0;color:var(--muted);text-align:center;max-width:520px;line-height:1.5;font-size:13px}
    .startup .cta{width:min(420px,100%);display:flex;flex-direction:column;gap:10px}

    /* Scanner ‚Äì n√©gyzetes kamera, no-scroll */
    .scannerWrap{display:flex;flex-direction:column;gap:12px}
    /* A scan section maga ne scrolloljon ‚Äì flexbox t√∂lti ki a marad√©k helyet */
    #view-scan{display:flex;flex-direction:column;height:calc(100vh - var(--navH) - env(safe-area-inset-bottom) - 56px);overflow:hidden}
    #view-scan .card.section{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-top:0}
    #view-scan .card.section > h2{flex-shrink:0}
    .scannerWrap{flex:1;overflow:hidden;display:flex;flex-direction:column;gap:10px}
    /* N√©gyzetes kamera: sz√©less√©g = magass√°g */
    .reader{position:relative;overflow:hidden;border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);background:#0b0b0b;
      width:100%;aspect-ratio:1/1;max-height:45vw;flex-shrink:0}
    @media (max-width:600px){.reader{max-height:60vw}}
    #qr-reader{position:absolute;inset:0;width:100%!important;height:100%!important}
    #qr-reader video{width:100%!important;height:100%!important;object-fit:cover;display:block!important}
    .viewfinder{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .vf-dim{position:absolute;inset:0;background:rgba(0,0,0,.22);
      mask:radial-gradient(circle at 50% 50%, transparent 0 110px, black 120px);
      -webkit-mask:radial-gradient(circle at 50% 50%, transparent 0 110px, black 120px)}
    .vf-box{width:min(72%,220px);aspect-ratio:1/1;border-radius:18px;border:2px solid rgba(212,175,55,.75);
      box-shadow:0 0 22px rgba(212,175,55,.12);position:relative}
    .vf-box:before{content:"";position:absolute;left:10px;right:10px;top:50%;height:1px;background:rgba(212,175,55,.35)}
    /* Status + preview r√©sz scrollolhat ha kell */
    .status{overflow-y:auto;flex:1}

    .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--text);font-size:12px;font-weight:700}
    .badge.gold{border-color:rgba(212,175,55,.35)} .badge.ok{border-color:rgba(57,217,138,.35);color:var(--ok)} .badge.warn{border-color:rgba(255,91,91,.35);color:var(--danger)}
    .status .line{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .preview{display:flex;gap:12px;align-items:flex-start}
    .cover{width:92px;height:92px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden;flex:0 0 auto}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .meta h3{margin:0 0 6px 0;font-size:16px;line-height:1.2}
    .meta p{margin:0;color:var(--muted);font-size:12px;line-height:1.4}

    /* Gy≈±jtem√©ny ‚Äì fix nav, scrollozhat√≥ lista */
    #view-collection{display:flex;flex-direction:column;height:calc(100vh - var(--navH) - env(safe-area-inset-bottom) - 56px);overflow:hidden}
    #view-collection .card.section{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-top:0}
    #view-collection .card.section > h2{flex-shrink:0}
    .coll-toolbar{display:flex;gap:8px;flex-shrink:0;margin-bottom:10px;flex-wrap:nowrap;overflow-x:auto}
    .coll-toolbar button{white-space:nowrap;flex-shrink:0;padding:10px 12px;font-size:13px}
    #collectionEmpty{flex-shrink:0}
    #collectionGrid{overflow-y:auto;flex:1;gap:8px}
    .collectionGrid{display:flex;flex-direction:column;gap:8px}
    .item{padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:background .15s;overflow:hidden;min-width:0}
    .item:hover{background:rgba(212,175,55,.05)}
    .item-check{width:18px;height:18px;flex:0 0 auto;accent-color:var(--gold);cursor:pointer}
    .thumb{width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden;flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .item .t{min-width:0;flex:1 1 auto;overflow:hidden}
    .item .t .a{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .item .t .b{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* R√©szletek modal */
    .modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:12px}
    .modal-box{background:var(--card);border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow);width:100%;max-width:min(560px,calc(100vw - 24px));max-height:88vh;overflow-y:auto;position:relative;padding:20px 16px 16px}
    .modal-close{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.1);border:none;color:var(--text);border-radius:50%;width:34px;height:34px;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:none;padding:0;line-height:1}
    .modal-header{display:flex;gap:16px;align-items:flex-start;margin-bottom:16px;padding-right:40px}
    .modal-cover{width:110px;height:110px;border-radius:14px;object-fit:cover;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);flex:0 0 auto}
    .modal-info{flex:1;min-width:0}
    .modal-info .m-artist{font-size:13px;color:var(--muted);margin-bottom:4px}
    .modal-info .m-title{font-size:18px;font-weight:800;line-height:1.2;margin:0}
    .detail-row{display:flex;justify-content:space-between;align-items:baseline;gap:12px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted);flex-shrink:0}
    .detail-val{font-weight:600;text-align:right;word-break:break-word}
    .tracklist-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:700;margin:14px 0 4px}
    .track-row{display:flex;justify-content:space-between;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px}
    .track-pos{color:var(--gold);min-width:28px;font-weight:700}
    .track-name{flex:1;color:var(--text)}
    .track-dur{color:var(--muted)}

    nav.bottom{position:fixed;left:0;right:0;bottom:0;height:calc(var(--navH) + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);
      background:rgba(18,18,18,.92);border-top:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px);display:flex;justify-content:center;z-index:50}
    .navInner{width:100%;max-width:var(--maxW);height:var(--navH);display:flex;align-items:center;justify-content:space-around;padding:10px 14px;gap:10px}
    .navBtn{flex:1;background:transparent;color:var(--muted);border:1px solid transparent;box-shadow:none;padding:10px;border-radius:16px;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:800;font-size:14px}
    .navBtn.active{color:var(--text);border-color:rgba(212,175,55,.35);background:rgba(212,175,55,.08)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--navH) + 18px + env(safe-area-inset-bottom));
      background:rgba(30,30,30,.96);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 16px;border-radius:999px;box-shadow:var(--shadow);
      font-size:12px;display:none;z-index:300;max-width:min(560px,92vw);text-align:center}
    .toast.show{display:block}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body>

  <!-- Fekv≈ë m√≥d overlay -->
  <div id="landscapeOverlay">
    <svg width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="6" y="18" width="38" height="26" rx="4" stroke="#d4af37" stroke-width="2.5"/>
      <circle cx="25" cy="31" r="5" stroke="#d4af37" stroke-width="2.5"/>
      <path d="M52 24 L64 36 L52 48" stroke="#d4af37" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="20" y="10" width="26" height="42" rx="4" stroke="rgba(212,175,55,0.25)" stroke-width="2" stroke-dasharray="4 3"/>
    </svg>
    <p>K√©rj√ºk, ford√≠tsd a telefont <strong style="color:var(--gold)">√°ll√≥ helyzetbe</strong> az alkalmaz√°s haszn√°lat√°hoz.</p>
  </div>

  <div class="app">
    <div class="container">
      <header>
        <div class="brand"><span class="dot"></span><h1>LP Katal√≥gus</h1></div>
        <div class="pill" id="pillState"><span>√Ållapot:</span> <strong id="pillStateText">K√©szen</strong></div>
      </header>

      <main>
        <!-- F≈ëoldal -->
        <section id="view-home">
          <div class="card section startup">
            <div class="vinyl" aria-hidden="true"></div>
            <p>Katal√≥gus√©p√≠t√©s eleg√°nsan: <strong>vonalk√≥d</strong> els≈ëbbs√©ggel, √©s ha kell <strong>OCR</strong> katal√≥gussz√°mra. Ment√©s el≈ëtt mindig kapsz <strong>el≈ën√©zetet</strong>.</p>
            <div class="cta">
              <button id="btnStartScan">√öj lemez beolvas√°sa</button>
              <button class="btn-ghost" id="btnInstallPwa" style="display:none;align-items:center;gap:8px;justify-content:center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#d4af37" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2z"/><circle cx="12" cy="12" r="3" fill="#d4af37" stroke="none"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke="#d4af37" stroke-width="1.5"/></svg>
                Alkalmaz√°s telep√≠t√©se
              </button>
            </div>
          </div>
        </section>

        <!-- Beolvas√°s -->
        <section id="view-scan" class="hidden">
          <div class="card section">
            <h2>Beolvas√°s</h2>
            <div class="scannerWrap">
              <div class="reader">
                <div id="qr-reader"></div>
                <div class="viewfinder"><div class="vf-dim" aria-hidden="true"></div><div class="vf-box" aria-hidden="true"></div></div>
              </div>

              <div class="status">
                <div class="card section" style="margin-top:0">
                  <h2>Folyamat</h2>
                  <div class="line"><span>Priorit√°s</span><span class="badge gold">EAN-13 vonalk√≥d</span></div>
                  <div class="line"><span>OCR fallback</span><span class="badge" id="ocrBadge">K√©szenl√©tben</span></div>
                  <div class="divider"></div>
                  <div class="line"><span>Tal√°lt k√≥d</span><span class="badge mono" id="foundCode">‚Äî</span></div>
                  <div class="line"><span>Forr√°s</span><span class="badge" id="foundSource">‚Äî</span></div>
                  <div class="divider"></div>
                  <div class="btn-row">
                    <button class="btn-muted" id="btnStopScan">Le√°ll√≠t√°s</button>
                    <button class="btn-ghost" id="btnRetry">√öjra</button>
                  </div>
                </div>

                <div class="card section hidden" id="previewCard">
                  <h2>El≈ën√©zet</h2>
                  <div class="preview">
                    <div class="cover" id="previewCover"></div>
                    <div class="meta">
                      <h3 id="previewTitle">‚Äî</h3>
                      <p id="previewDetails">‚Äî</p>
                    </div>
                  </div>
                  <div class="divider"></div>
                  <div class="grid2">
                    <div>
                      <label>√Ållapot</label>
                      <select id="gradeSelect">
                        <option value="M">Mint (M)</option>
                        <option value="NM" selected>Majdnem mint (NM)</option>
                        <option value="VG+">Nagyon j√≥+ (VG+)</option>
                        <option value="VG">Nagyon j√≥ (VG)</option>
                        <option value="G+">J√≥+ (G+)</option>
                        <option value="G">J√≥ (G)</option>
                        <option value="F">Megfelel≈ë (F)</option>
                        <option value="P">Gyenge (P)</option>
                      </select>
                    </div>
                    <div>
                      <label>Katal√≥gussz√°m (fel√ºl√≠rhat√≥)</label>
                      <input id="catnoInput" placeholder="pl. SLPX 1234" />
                    </div>
                  </div>
                  <div class="btn-row" style="margin-top:12px">
                    <button id="btnApproveSave">Ment√©s a gy≈±jtem√©nybe</button>
                    <button class="btn-ghost" id="btnReject">Elutas√≠t√°s</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Gy≈±jtem√©ny -->
        <section id="view-collection" class="hidden">
          <div class="card section">
            <h2>Gy≈±jtem√©nyem</h2>
            <div class="coll-toolbar">
              <button id="btnExportPdf">PDF</button>
              <button class="btn-ghost" id="btnExportXlsx">XLSX</button>
              <button class="btn-danger" id="btnDeleteSelected">Kijel√∂lt t√∂rl√©se</button>
            </div>
            <div id="collectionEmpty" class="card section" style="margin-top:0;background:rgba(255,255,255,.03);box-shadow:none;flex-shrink:0">
              <h2>Nincs m√©g lemez</h2>
              <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.5;">A gy≈±jtem√©nyed √ºres. L√©pj a Kezd≈ëlapra, √©s v√°laszd az <strong>‚Äû√öj lemez beolvas√°sa"</strong> gombot.</p>
            </div>
            <div id="collectionGrid" class="collectionGrid hidden"></div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- R√©szletek modal -->
  <div id="detailModal" class="modal-overlay hidden">
    <div class="modal-box">
      <button class="modal-close" id="btnModalClose" aria-label="Bez√°r√°s">‚úï</button>
      <div class="modal-header">
        <img id="modalCover" class="modal-cover" src="" alt="Bor√≠t√≥" style="display:none">
        <div class="modal-info">
          <div class="m-artist" id="modalArtist"></div>
          <div class="m-title" id="modalTitle"></div>
        </div>
      </div>
      <div id="modalDetails"></div>
    </div>
  </div>

  <nav class="bottom">
    <div class="navInner">
      <button class="navBtn active" id="navHome">üè† Kezd≈ëlap</button>
      <button class="navBtn" id="navCollection">üéµ Gy≈±jtem√©nyem</button>
    </div>
  </nav>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js"></script>

  <script>
    async function waitForLibs(){
      const start=Date.now();
      while(true){
        if(window.Tesseract) return true;
        if(Date.now()-start>10000) throw new Error("LIB_LOAD_TIMEOUT");
        await new Promise(r=>setTimeout(r,100));
      }
    }

    const LS_KEY="lp_catalog_v1_records";
    const CATNO_REGEX=/\b(?:SLPX|LPX|SLPM)\s*[-]?\s*\d{2,6}\b/gi;
    const DISCOGS_PROXY="/api/discogs";

    const GRADE_HU={
      "M":"Mint (M)","NM":"Majdnem mint (NM)","VG+":"Nagyon j√≥+ (VG+)",
      "VG":"Nagyon j√≥ (VG)","G+":"J√≥+ (G+)","G":"J√≥ (G)","F":"Megfelel≈ë (F)","P":"Gyenge (P)"
    };

    const state={
      view:"home",
      scanner:{running:false,stream:null,ocrTimer:null,barcodeFound:false,animFrame:null},
      preview:null
    };

    const $=s=>document.querySelector(s);
    const views={home:$("#view-home"),scan:$("#view-scan"),collection:$("#view-collection")};
    const nav={home:$("#navHome"),collection:$("#navCollection")};

    function setPill(t){$("#pillStateText").textContent=t;}
    function toast(msg,ms=2400){
      const t=$("#toast"); t.textContent=msg; t.classList.add("show");
      clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.classList.remove("show"),ms);
    }

    function setView(name){
      state.view=name;
      for(const k in views) views[k].classList.toggle("hidden",k!==name);
      for(const k in nav) nav[k].classList.toggle("active",k===name);
      if(name!=="scan") stopScan();
      if(name==="collection") renderCollection();
    }

    function loadRecords(){
      try{const r=localStorage.getItem(LS_KEY);const a=r?JSON.parse(r):[];return Array.isArray(a)?a:[];}catch{return[];}
    }
    function saveRecords(a){localStorage.setItem(LS_KEY,JSON.stringify(a));}
    function addRecord(rec){
      const a=loadRecords();
      a.push(rec);
      a.sort((x,y)=>(x.artist||"").localeCompare(y.artist||"","hu")||(x.title||"").localeCompare(y.title||"","hu"));
      saveRecords(a);
    }

    function escapeAttr(s){return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
    function escapeText(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
    function csvEscape(v){const s=(v??"").toString().replaceAll("\r"," ").replaceAll("\n"," ");return(/[",]/.test(s))?`"${s.replaceAll('"','""')}"`:`${s}`;}

    function summarizeRec(rec){
      const parts=[];
      if(rec.year) parts.push(rec.year);
      if(rec.label) parts.push(rec.label);
      if(rec.catno) parts.push("Cat#: "+rec.catno);
      if(rec.grade) parts.push(GRADE_HU[rec.grade]||rec.grade);
      return parts.join(" ‚Ä¢ ")||"‚Äî";
    }

    // ‚îÄ‚îÄ DISCOGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function proxyFetch(endpoint){
      const url=new URL(DISCOGS_PROXY,location.origin);
      url.searchParams.set("endpoint",endpoint);
      const res=await fetch(url.toString());
      if(!res.ok) throw new Error("Proxy/Discogs hiba ("+res.status+")");
      return res.json();
    }
    const discogsSearchByBarcode=b=>proxyFetch("database/search?"+new URLSearchParams({barcode:b,type:"release",per_page:"5"}));
    const discogsSearchByCatno=c=>proxyFetch("database/search?"+new URLSearchParams({catno:c,type:"release",per_page:"5"}));
    const discogsGetRelease=id=>proxyFetch("releases/"+encodeURIComponent(id));

    function normalizeRelease(release,fallbackCatno=""){
      const artist=(release.artists||[]).map(a=>a?.name).filter(Boolean).join(", ").replace(/\s+\(\d+\)$/,"")||"";
      const title=release.title||"Ismeretlen c√≠m";
      const year=release.year?String(release.year):"";
      const label=(release.labels||[]).map(l=>l?.name).filter(Boolean).slice(0,2).join(", ");
      const catno=(release.labels||[]).map(l=>l?.catno).filter(Boolean).find(Boolean)||fallbackCatno||"";
      const cover=release.images?.find(i=>i.type==="primary")?.uri||release.images?.[0]?.uri||release.thumb||"";
      const country=release.country||"";
      const genres=(release.genres||[]).join(", ");
      const styles=(release.styles||[]).join(", ");
      const formats=(release.formats||[]).map(f=>[f.name,...(f.descriptions||[])].join(" ")).filter(Boolean).join(", ");
      const notes=release.notes||"";
      const tracklist=release.tracklist||[];
      return{
        id:crypto.randomUUID(),discogsReleaseId:release.id||null,
        artist,title,year,label,catno,grade:"NM",coverUrl:cover,
        country,genres,styles,formats,notes,tracklist,
        createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()
      };
    }

    async function fetchAndPreview({barcode=null,catno=null}){
      try{
        setPill("Discogs‚Ä¶");
        const search=barcode?await discogsSearchByBarcode(barcode):await discogsSearchByCatno(catno);
        const best=search?.results?.[0];
        if(!best){toast("Nincs Discogs tal√°lat.");setPill("K√©szen");return;}
        const release=await discogsGetRelease(best.id);
        const rec=normalizeRelease(release,catno||"");
        $("#catnoInput").value=rec.catno||(catno||"");
        $("#gradeSelect").value="NM";
        state.preview=rec;
        $("#previewCover").innerHTML=rec.coverUrl?`<img alt="Bor√≠t√≥" src="${escapeAttr(rec.coverUrl)}">`:"";
        $("#previewTitle").textContent=`${rec.artist} ‚Äî ${rec.title}`;
        $("#previewDetails").textContent=summarizeRec(rec);
        $("#previewCard").classList.remove("hidden");
        setPill("El≈ën√©zet");
      }catch(e){
        console.error(e);
        toast("Discogs hiba: ellen≈ërizd a /api/discogs proxyt √©s a DISCOGS_TOKEN env var-t.");
        setPill("K√©szen");
      }
    }

    // ‚îÄ‚îÄ NAT√çV KAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getVideo(){return document.querySelector("#qr-reader video");}

    async function stopScan(keepView=false){
      clearTimeout(state.scanner.ocrTimer);
      cancelAnimationFrame(state.scanner.animFrame);
      state.scanner.animFrame=null;
      if(state.scanner.stream){
        state.scanner.stream.getTracks().forEach(t=>t.stop());
        state.scanner.stream=null;
      }
      const v=getVideo();
      if(v){v.srcObject=null;}
      state.scanner.running=false;
      if(!keepView && state.view==="scan") setView("home");
      setPill("K√©szen");
    }

    async function startScan(){
      if(state.scanner.running) return;
      if(state.scanner.stream){await stopScan(true);}

      setView("scan");
      setPill("Kamera ind√≠t√°sa‚Ä¶");
      $("#previewCard").classList.add("hidden");
      state.preview=null;
      $("#foundCode").textContent="‚Äî";
      $("#foundSource").textContent="‚Äî";
      $("#ocrBadge").textContent="K√©szenl√©tben";
      $("#ocrBadge").className="badge";
      state.scanner.running=true;
      state.scanner.barcodeFound=false;

      const container=$("#qr-reader");
      container.innerHTML="";
      const vid=document.createElement("video");
      vid.setAttribute("playsinline","");
      vid.setAttribute("webkit-playsinline","");
      vid.muted=true;
      vid.autoplay=true;
      vid.style.cssText="width:100%;height:100%;object-fit:cover;display:block;";
      container.appendChild(vid);

      try{
        const stream=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},
          audio:false
        });
        if(!state.scanner.running){stream.getTracks().forEach(t=>t.stop());return;}
        state.scanner.stream=stream;
        vid.srcObject=stream;
        await vid.play();
        setPill("Beolvas√°s");

        const hasBarcodeDetector="BarcodeDetector" in window;
        let detector=null;
        if(hasBarcodeDetector){
          detector=new BarcodeDetector({formats:["ean_13","ean_8","upc_a","upc_e","code_128","code_39"]});
        }

        let lastScan=0;
        async function scanLoop(){
          if(!state.scanner.running||state.scanner.barcodeFound) return;
          state.scanner.animFrame=requestAnimationFrame(scanLoop);
          if(vid.readyState<2) return;
          const now=Date.now();
          if(hasBarcodeDetector && now-lastScan>100){
            lastScan=now;
            try{
              const barcodes=await detector.detect(vid);
              for(const bc of barcodes){
                const cleaned=String(bc.rawValue||"").replace(/\s/g,"");
                if(/^\d{13}$/.test(cleaned)){
                  state.scanner.barcodeFound=true;
                  cancelAnimationFrame(state.scanner.animFrame);
                  $("#foundCode").textContent=cleaned;
                  $("#foundSource").textContent="Vonalk√≥d";
                  $("#ocrBadge").textContent="Nem sz√ºks√©ges";
                  $("#ocrBadge").className="badge ok";
                  toast("Vonalk√≥d √©szlelve: "+cleaned);
                  await stopScan(true);
                  await fetchAndPreview({barcode:cleaned});
                  return;
                }
              }
            }catch(_){}
          }
        }
        scanLoop();
        scheduleOcrFallback();

      }catch(e){
        console.error("Kamera hiba:",e);
        state.scanner.running=false;
        state.scanner.stream=null;
        container.innerHTML="";
        const msg=String(e?.name||e?.message||"").toLowerCase();
        if(msg.includes("notallowed")||msg.includes("permission")||msg.includes("denied")){
          toast("Kamera hozz√°f√©r√©s megtagadva ‚Äî enged√©lyezd a b√∂ng√©sz≈ëben!");
        }else if(msg.includes("notfound")||msg.includes("devicenotfound")){
          toast("Nem tal√°lhat√≥ kamera ezen az eszk√∂z√∂n.");
        }else if(msg.includes("notreadable")||msg.includes("trackstarterror")){
          toast("A kamera foglalt ‚Äî z√°rd be a t√∂bbi appot, majd pr√≥b√°ld √∫jra.");
        }else{
          toast("Kamera hiba: "+(e?.name||e?.message||"ismeretlen"));
        }
        setPill("Hiba");
        setView("home");
      }
    }

    // OCR fallback ‚Äì gyorsabb be√°ll√≠t√°sokkal, 5s k√©sleltet√©s
    function scheduleOcrFallback(){
      clearTimeout(state.scanner.ocrTimer);
      state.scanner.ocrTimer=setTimeout(async()=>{
        if(!state.scanner.running||state.scanner.barcodeFound) return;
        $("#ocrBadge").textContent="OCR fut‚Ä¶";
        $("#ocrBadge").className="badge gold";
        setPill("OCR‚Ä¶");
        try{
          const catno=await runOcrForCatno();
          if(!catno){
            $("#ocrBadge").textContent="Nincs tal√°lat";
            $("#ocrBadge").className="badge warn";
            setPill("Beolvas√°s");
            scheduleOcrFallback();
            return;
          }
          $("#foundCode").textContent=catno;
          $("#foundSource").textContent="OCR";
          $("#ocrBadge").textContent="Tal√°lat";
          $("#ocrBadge").className="badge ok";
          toast("Katal√≥gussz√°m √©szlelve: "+catno);
          await stopScan(true);
          await fetchAndPreview({catno});
        }catch(e){
          console.error(e);
          $("#ocrBadge").textContent="OCR hiba";
          $("#ocrBadge").className="badge warn";
          setPill("Beolvas√°s");
          scheduleOcrFallback();
        }
      },5000);
    }

    async function runOcrForCatno(){
      const v=getVideo();
      if(!v||v.readyState<2) return null;
      const vw=v.videoWidth,vh=v.videoHeight;
      if(!vw||!vh) return null;
      // Kisebb crop + scale le = sokkal gyorsabb
      const crop=Math.floor(Math.min(vw,vh)*0.5);
      const sx=Math.floor((vw-crop)/2),sy=Math.floor((vh-crop)/2);
      const scale=0.5;
      const c=document.createElement("canvas");
      c.width=Math.floor(crop*scale);
      c.height=Math.floor(crop*scale);
      const ctx=c.getContext("2d",{willReadFrequently:true});
      ctx.drawImage(v,sx,sy,crop,crop,0,0,c.width,c.height);
      const r=await Tesseract.recognize(c,"eng",{
        logger:()=>{},
        tessedit_pageseg_mode:"7",
        tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789- "
      });
      const text=(r?.data?.text||"").toUpperCase();
      const m=text.match(CATNO_REGEX);
      return m?.[0]?.replace(/\s+/g," ").trim()||null;
    }

    // ‚îÄ‚îÄ GY≈∞JTEM√âNY MEGJELEN√çT√âS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderCollection(){
      const all=loadRecords();
      const empty=$("#collectionEmpty");
      const grid=$("#collectionGrid");
      if(!all.length){
        empty.classList.remove("hidden");
        grid.classList.add("hidden");
        grid.innerHTML="";
        return;
      }
      empty.classList.add("hidden");
      grid.classList.remove("hidden");
      grid.innerHTML=all.map((rec,i)=>`
        <div class="card item" data-idx="${i}">
          <input type="checkbox" class="item-check" data-idx="${i}" onclick="event.stopPropagation()" aria-label="Kijel√∂l√©s">
          <div class="thumb">${rec.coverUrl?`<img alt="Bor√≠t√≥" src="${escapeAttr(rec.coverUrl)}">`:""}</div>
          <div class="t">
            <div class="a">${escapeText(rec.artist||"‚Äî")}</div>
            <div class="b">${escapeText(rec.title||"‚Äî")}</div>
          </div>
        </div>`).join("");

      grid.querySelectorAll(".item").forEach(el=>{
        el.addEventListener("click",e=>{
          if(e.target.classList.contains("item-check")) return;
          openDetailModal(loadRecords()[parseInt(el.dataset.idx)]);
        });
      });
    }

    // ‚îÄ‚îÄ R√âSZLETEK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openDetailModal(rec){
      const cover=$("#modalCover");
      if(rec.coverUrl){cover.src=rec.coverUrl;cover.style.display="block";}
      else{cover.style.display="none";}
      $("#modalArtist").textContent=rec.artist||"";
      $("#modalTitle").textContent=rec.title||"‚Äî";

      const fields=[
        ["√âv",rec.year],
        ["Kiad√≥",rec.label],
        ["Katal√≥gussz√°m",rec.catno],
        ["√Ållapot",GRADE_HU[rec.grade]||rec.grade],
        ["Form√°tum",rec.formats],
        ["Orsz√°g",rec.country],
        ["M≈±faj",rec.genres],
        ["St√≠lus",rec.styles],
        ["Discogs ID",rec.discogsReleaseId?String(rec.discogsReleaseId):""],
        ["Hozz√°adva",rec.createdAt?new Date(rec.createdAt).toLocaleDateString("hu-HU"):""],
      ].filter(([,v])=>v);

      let html=fields.map(([l,v])=>
        `<div class="detail-row"><span class="detail-label">${escapeText(l)}</span><span class="detail-val">${escapeText(String(v))}</span></div>`
      ).join("");

      if(rec.tracklist&&rec.tracklist.length){
        html+=`<div class="tracklist-title">Sz√°mlista</div>`;
        html+=rec.tracklist.map(t=>
          `<div class="track-row"><span class="track-pos">${escapeText(t.position||"")}</span><span class="track-name">${escapeText(t.title||"")}</span><span class="track-dur">${escapeText(t.duration||"")}</span></div>`
        ).join("");
      }

      $("#modalDetails").innerHTML=html;
      $("#detailModal").classList.remove("hidden");
    }

    function closeDetailModal(){
      $("#detailModal").classList.add("hidden");
    }

    // ‚îÄ‚îÄ XLSX / PDF EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function exportXlsx(){
      const records=loadRecords();
      if(!records.length){toast("Nincs mit export√°lni.");return;}
      toast("XLSX gener√°l√°s‚Ä¶");
      if(!window.XLSX){
        await new Promise((res,rej)=>{
          const s=document.createElement("script");
          s.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
          s.onload=res; s.onerror=rej;
          document.head.appendChild(s);
        });
      }
      const headers=["El≈ëad√≥","C√≠m","√âv","Kiad√≥","Katal√≥gussz√°m","√Ållapot","Orsz√°g","M≈±faj","St√≠lus","Form√°tum","Discogs ID","Bor√≠t√≥ URL","Hozz√°adva"];
      const rows=records.map(r=>[
        r.artist||"",r.title||"",r.year||"",r.label||"",r.catno||"",
        GRADE_HU[r.grade]||r.grade||"",r.country||"",r.genres||"",r.styles||"",
        r.formats||"",r.discogsReleaseId?String(r.discogsReleaseId):"",
        r.coverUrl||"",r.createdAt?new Date(r.createdAt).toLocaleDateString("hu-HU"):""
      ]);
      const ws=XLSX.utils.aoa_to_sheet([headers,...rows]);
      ws["!cols"]=[20,28,6,20,14,18,12,16,16,14,10,30,12].map(w=>({wch:w}));
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"LP Katal√≥gus");
      const name=`lp-gyujtemeny-${new Date().toISOString().slice(0,10)}.xlsx`;
      const wbArr=XLSX.write(wb,{bookType:"xlsx",type:"array"});
      const blob=new Blob([wbArr],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const file=new File([blob],name,{type:blob.type});
      try{
        if(navigator.canShare&&navigator.canShare({files:[file]})){
          await navigator.share({title:"LP Gy≈±jtem√©ny",files:[file]});
          toast("Megoszt√°s elind√≠tva.");return;
        }
      }catch(e){if(e?.name!=="AbortError") console.warn(e);}
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(url);
      toast("XLSX let√∂ltve.");
    }

    function exportPdf(){
      const records=loadRecords();
      if(!records.length){toast("Nincs mit export√°lni.");return;}
      const rows=records.map(r=>`
        <tr>
          <td>${escapeText(r.artist||"‚Äî")}</td>
          <td>${escapeText(r.title||"‚Äî")}</td>
          <td>${escapeText(r.year||"")}</td>
          <td>${escapeText(r.label||"")}</td>
          <td>${escapeText(r.catno||"")}</td>
          <td>${escapeText(GRADE_HU[r.grade]||r.grade||"")}</td>
        </tr>`).join("");
      const html=`<!doctype html><html><head><meta charset="utf-8"><title>LP Katal√≥gus</title>
        <style>
          body{font-family:Arial,sans-serif;font-size:11px;color:#222;padding:24px;margin:0}
          h1{font-size:20px;margin:0 0 4px;color:#111}
          .sub{color:#888;font-size:10px;margin:0 0 18px}
          table{width:100%;border-collapse:collapse}
          th{background:#d4af37;color:#111;padding:7px 9px;text-align:left;font-size:10px;letter-spacing:.05em;text-transform:uppercase}
          td{padding:6px 9px;border-bottom:1px solid #eee;vertical-align:top}
          tr:nth-child(even) td{background:#fafafa}
          @media print{body{padding:0}}
        </style></head><body>
        <h1>LP Katal√≥gus</h1>
        <p class="sub">Export√°lva: ${new Date().toLocaleDateString("hu-HU")} ‚Äî √∂sszesen ${records.length} lemez</p>
        <table>
          <thead><tr><th>El≈ëad√≥</th><th>C√≠m</th><th>√âv</th><th>Kiad√≥</th><th>Kat.sz.</th><th>√Ållapot</th></tr></thead>
          <tbody>${rows}</tbody>
        </table></body></html>`;
      const w=window.open("","_blank");
      if(!w){toast("Enged√©lyezd a felugr√≥ ablakokat a PDF exporthoz.");return;}
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>{w.print();},600);
    }

    // ‚îÄ‚îÄ UI K√ñT√âSEK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function bindUI(){
      $("#btnStartScan").addEventListener("click",startScan);
      $("#btnStopScan").addEventListener("click",()=>stopScan(false));
      $("#btnRetry").addEventListener("click",()=>{stopScan(true).finally(()=>startScan());});

      $("#btnApproveSave").addEventListener("click",()=>{
        if(!state.preview) return;
        const grade=$("#gradeSelect").value;
        const catno=($("#catnoInput").value||"").trim();
        // Duplik√°ci√≥ ellen≈ërz√©s
        const existing=loadRecords();
        const dup=existing.find(r=>
          r.discogsReleaseId && state.preview.discogsReleaseId &&
          String(r.discogsReleaseId)===String(state.preview.discogsReleaseId)
        );
        if(dup){
          const yes=confirm(`Ez a lemez m√°r szerepel a gy≈±jtem√©nyben:
"${dup.artist} ‚Äî ${dup.title}"

Biztosan t√∂bb p√©ld√°nyod van bel≈ële, √©s szeretn√©d √∫jra menteni?`);
          if(!yes) return;
        }
        addRecord({...state.preview,grade,catno,updatedAt:new Date().toISOString()});
        toast("Mentve a gy≈±jtem√©nybe.");
        state.preview=null;
        $("#previewCard").classList.add("hidden");
        setView("collection");
      });
      $("#btnReject").addEventListener("click",()=>{
        state.preview=null;
        $("#previewCard").classList.add("hidden");
        toast("El≈ën√©zet elutas√≠tva.");
      });

      $("#btnExportXlsx").addEventListener("click",exportXlsx);
      $("#btnExportPdf").addEventListener("click",exportPdf);

      (()=>{
        const btn=$("#btnDeleteSelected");
        let pressTimer=null;
        // R√∂vid kattint√°s: kijel√∂ltek t√∂rl√©se
        btn.addEventListener("click",()=>{
          const checked=[...document.querySelectorAll(".item-check:checked")].map(el=>parseInt(el.dataset.idx));
          if(!checked.length){toast("Nincs kijel√∂lt lemez.");return;}
          if(!confirm(`Biztosan t√∂rl√∂d a ${checked.length} kijel√∂lt lemezt?`)) return;
          const all=loadRecords();
          saveRecords(all.filter((_,i)=>!checked.includes(i)));
          toast(`${checked.length} lemez t√∂r√∂lve.`);
          renderCollection();
        });
        // Hosszan nyomva: √∂sszes t√∂rl√©se
        btn.addEventListener("pointerdown",()=>{
          pressTimer=setTimeout(()=>{
            if(!confirm("Biztosan t√∂rl√∂d az √∂sszes mentett lemezt?")) return;
            saveRecords([]);toast("Gy≈±jtem√©ny t√∂r√∂lve.");renderCollection();
          },800);
        });
        ["pointerup","pointerleave","pointercancel"].forEach(ev=>
          btn.addEventListener(ev,()=>clearTimeout(pressTimer))
        );
      })();

      const installBtn=$("#btnInstallPwa");
      if(installBtn){
        installBtn.addEventListener("click",async()=>{
          if(!deferredInstallPrompt) return;
          deferredInstallPrompt.prompt();
          const {outcome}=await deferredInstallPrompt.userChoice;
          if(outcome==="accepted") installBtn.style.display="none";
          deferredInstallPrompt=null;
        });
      }
      nav.home.addEventListener("click",()=>setView("home"));
      nav.collection.addEventListener("click",()=>setView("collection"));

      $("#btnModalClose").addEventListener("click",closeDetailModal);
      $("#detailModal").addEventListener("click",e=>{if(e.target===$("#detailModal")) closeDetailModal();});

      document.addEventListener("visibilitychange",()=>{if(document.hidden) stopScan(true);});
    }

    // PWA install prompt
    let deferredInstallPrompt=null;
    window.addEventListener("beforeinstallprompt",e=>{
      e.preventDefault();
      deferredInstallPrompt=e;
      const btn=$("#btnInstallPwa");
      if(btn) btn.style.display="flex";
    });

    window.addEventListener("load",async()=>{
      try{await waitForLibs();}
      catch(e){console.error(e);toast("Tesseract nem t√∂lt≈ëd√∂tt be. Friss√≠ts √©s pr√≥b√°ld √∫jra.");}
      bindUI();
      renderCollection();
      if("serviceWorker" in navigator){try{await navigator.serviceWorker.register("./sw.js");}catch{}}
    });
  </script>
</body>
</html>
