<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#121212" />
  <title>LP Katalógus</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --bg:#121212; --card:#1e1e1e; --text:#e0e0e0; --muted:#a6a6a6; --gold:#d4af37;
      --danger:#ff5b5b; --ok:#39d98a; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.45);
      --navH:72px; --maxW:980px; --focus:0 0 0 3px rgba(212,175,55,.28);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
    .app{min-height:100%;padding-bottom:calc(var(--navH) + env(safe-area-inset-bottom));display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxW);padding:18px 16px 22px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 4px 6px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--gold);box-shadow:0 0 22px rgba(212,175,55,.65)}
    .brand h1{margin:0;font-size:16px;letter-spacing:.12em;text-transform:uppercase;font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:var(--muted);font-size:12px;user-select:none}
    .pill strong{color:var(--text);font-weight:600}
    .hidden{display:none !important}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .section{margin-top:14px;padding:16px}
    .section h2{margin:0 0 10px 0;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:700}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    button{appearance:none;border:0;cursor:pointer;border-radius:14px;padding:12px 14px;font-weight:700;letter-spacing:.02em;color:var(--bg);background:var(--gold);box-shadow:0 10px 22px rgba(212,175,55,.15)}
    button:focus-visible{outline:none;box-shadow:var(--shadow),var(--focus)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(212,175,55,.35);box-shadow:none}
    .btn-muted{background:rgba(255,255,255,.06);color:var(--text);box-shadow:none}
    .btn-danger{background:var(--danger);color:#120c0c;box-shadow:none}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.22);color:var(--text);outline:none}
    input:focus,select:focus{box-shadow:var(--focus);border-color:rgba(212,175,55,.5)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .startup{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - var(--navH) - 100px);padding:22px 10px;gap:18px}
    .vinyl{width:220px;height:220px;position:relative;border-radius:50%;background:
      radial-gradient(circle at 50% 50%, rgba(212,175,55,.95) 0 8px, transparent 9px),
      radial-gradient(circle at 50% 50%, rgba(0,0,0,.0) 0 40px, rgba(0,0,0,.45) 41px),
      radial-gradient(circle at 50% 50%, #101010 0 46%, #0b0b0b 60%, #141414 70%, #0a0a0a 100%);
      box-shadow:0 28px 60px rgba(0,0,0,.6),0 0 40px rgba(212,175,55,.08);border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .vinyl:before{content:"";position:absolute;inset:-2px;border-radius:50%;
      background:repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.05) 0 1px, rgba(255,255,255,0) 2px 10px);
      mix-blend-mode:overlay;opacity:.6}
    .vinyl:after{content:"";position:absolute;width:52px;height:52px;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:50%;
      background:radial-gradient(circle,#d4af37 0 10px,#161616 11px 100%);border:1px solid rgba(255,255,255,.08);box-shadow:0 0 18px rgba(212,175,55,.25)}
    .startup p{margin:0;color:var(--muted);text-align:center;max-width:520px;line-height:1.5;font-size:13px}
    .startup .cta{width:min(420px,100%);display:flex;flex-direction:column;gap:10px}
    .scannerWrap{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:start}
    @media (max-width:860px){.scannerWrap{grid-template-columns:1fr}}
    .reader{position:relative;overflow:hidden;border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);background:#0b0b0b;min-height:360px}
    #qr-reader{width:100%;height:100%;min-height:360px;position:relative}
    #qr-reader video,#qr-reader canvas{width:100%!important;height:100%!important;object-fit:cover;display:block!important}
    .viewfinder{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .vf-dim{position:absolute;inset:0;background:rgba(0,0,0,.22);
      mask:radial-gradient(circle at 50% 50%, transparent 0 190px, black 200px);
      -webkit-mask:radial-gradient(circle at 50% 50%, transparent 0 190px, black 200px)}
    .vf-box{width:min(72%,320px);aspect-ratio:1/1;border-radius:18px;border:2px solid rgba(212,175,55,.75);
      box-shadow:0 0 22px rgba(212,175,55,.12);position:relative}
    .vf-box:before{content:"";position:absolute;left:10px;right:10px;top:50%;height:1px;background:rgba(212,175,55,.35)}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--text);font-size:12px;font-weight:700}
    .badge.gold{border-color:rgba(212,175,55,.35)} .badge.ok{border-color:rgba(57,217,138,.35)} .badge.warn{border-color:rgba(255,91,91,.35)}
    .status .line{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .preview{display:flex;gap:12px;align-items:flex-start}
    .cover{width:92px;height:92px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden;flex:0 0 auto}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .meta h3{margin:0 0 6px 0;font-size:16px;line-height:1.2}
    .meta p{margin:0;color:var(--muted);font-size:12px;line-height:1.4}
    .collectionGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){.collectionGrid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.collectionGrid{grid-template-columns:1fr}}
    .item{padding:12px;display:flex;gap:12px;align-items:center}
    .thumb{width:64px;height:64px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden;flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .item .t{min-width:0;flex:1 1 auto}
    .item .t .a{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .item .t .b{font-size:14px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    nav.bottom{position:fixed;left:0;right:0;bottom:0;height:calc(var(--navH) + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);
      background:rgba(18,18,18,.92);border-top:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px);display:flex;justify-content:center;z-index:50}
    .navInner{width:100%;max-width:var(--maxW);height:var(--navH);display:flex;align-items:center;justify-content:space-around;padding:10px 14px;gap:10px}
    .navBtn{flex:1;background:transparent;color:var(--muted);border:1px solid transparent;box-shadow:none;padding:10px;border-radius:16px;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800}
    .navBtn.active{color:var(--text);border-color:rgba(212,175,55,.35);background:rgba(212,175,55,.08)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--navH) + 18px + env(safe-area-inset-bottom));
      background:rgba(30,30,30,.96);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:999px;box-shadow:var(--shadow);
      font-size:12px;display:none;z-index:120;max-width:min(560px,92vw);text-align:center}
    .toast.show{display:block}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body>
  <div class="app">
    <div class="container">
      <header>
        <div class="brand"><span class="dot"></span><h1>LP Katalógus</h1></div>
        <div class="pill" id="pillState"><span>Állapot:</span> <strong id="pillStateText">Készen</strong></div>
      </header>

      <main>
        <section id="view-home">
          <div class="card section startup">
            <div class="vinyl" aria-hidden="true"></div>
            <p>Katalógusépítés elegánsan: <strong>vonalkód</strong> elsőbbséggel, és ha kell <strong>OCR</strong> katalógusszámra. Mentés előtt mindig kapsz <strong>előnézetet</strong>.</p>
            <div class="cta">
              <button id="btnStartScan">Új lemez beolvasása</button>
              <button class="btn-ghost" id="btnGoCollection">Gyűjteményem megnyitása</button>
            </div>
          </div>
        </section>

        <section id="view-scan" class="hidden">
          <div class="card section">
            <h2>Beolvasás</h2>
            <div class="scannerWrap">
              <div class="reader">
                <div id="qr-reader"></div>
                <div class="viewfinder"><div class="vf-dim" aria-hidden="true"></div><div class="vf-box" aria-hidden="true"></div></div>
              </div>

              <div class="status">
                <div class="card section" style="margin-top:0">
                  <h2>Folyamat</h2>
                  <div class="line"><span>Prioritás</span><span class="badge gold">EAN-13 vonalkód</span></div>
                  <div class="line"><span>OCR fallback</span><span class="badge" id="ocrBadge">Készenlétben</span></div>
                  <div class="divider"></div>
                  <div class="line"><span>Talált kód</span><span class="badge mono" id="foundCode">—</span></div>
                  <div class="line"><span>Forrás</span><span class="badge" id="foundSource">—</span></div>
                  <div class="divider"></div>
                  <div class="btn-row">
                    <button class="btn-muted" id="btnStopScan">Leállítás</button>
                    <button class="btn-ghost" id="btnRetry">Újra</button>
                  </div>
                </div>

                <div class="card section hidden" id="previewCard">
                  <h2>Előnézet</h2>
                  <div class="preview">
                    <div class="cover" id="previewCover"></div>
                    <div class="meta">
                      <h3 id="previewTitle">—</h3>
                      <p id="previewDetails">—</p>
                    </div>
                  </div>
                  <div class="divider"></div>
                  <div class="grid2">
                    <div>
                      <label>Állapot (grading)</label>
                      <select id="gradeSelect">
                        <option value="M">M</option>
                        <option value="NM" selected>NM</option>
                        <option value="VG+">VG+</option>
                        <option value="VG">VG</option>
                        <option value="G">G</option>
                      </select>
                    </div>
                    <div>
                      <label>Katalógusszám (felülírható)</label>
                      <input id="catnoInput" placeholder="pl. SLPX 1234" />
                    </div>
                  </div>
                  <div class="btn-row" style="margin-top:12px">
                    <button id="btnApproveSave">Mentés a gyűjteménybe</button>
                    <button class="btn-ghost" id="btnReject">Elutasítás</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="view-collection" class="hidden">
          <div class="card section">
            <h2>Gyűjteményem</h2>
            <div class="btn-row" style="margin-bottom:12px">
              <button class="btn-ghost" id="btnExportCsv">Exportálás CSV-be</button>
              <button class="btn-muted" id="btnClearAll">Összes törlése</button>
            </div>
            <div id="collectionEmpty" class="card section" style="margin-top:0;background:rgba(255,255,255,.03);box-shadow:none;">
              <h2>Nincs még lemez</h2>
              <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.5;">A gyűjteményed üres. Lépj a Kezdőlapra, és válaszd az <strong>„Új lemez beolvasása”</strong> gombot.</p>
            </div>
            <div id="collectionGrid" class="collectionGrid hidden"></div>
          </div>
        </section>

        <section id="view-settings" class="hidden">
          <div class="card section">
            <h2>Beállítások</h2>
            <div class="card section" style="margin-top:0;background:rgba(255,255,255,.03);box-shadow:none;">
              <h2>Discogs token</h2>
              <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.5;">
                A token <strong>nem</strong> az index.html-ben van. Vercel-ben állítsd be környezeti változóként:
                <span class="mono">DISCOGS_TOKEN</span>. A kliens a <span class="mono">/api/discogs</span> proxyt hívja.
              </p>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <nav class="bottom">
    <div class="navInner">
      <button class="navBtn active" id="navHome">Kezdőlap</button>
      <button class="navBtn" id="navCollection">Gyűjteményem</button>
      <button class="navBtn" id="navSettings">Beállítások</button>
    </div>
  </nav>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- html5-qrcode eltávolítva: natív getUserMedia + BarcodeDetector váltotta fel -->
  <script src="https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js"></script>

  <script>
    async function waitForLibs(){
      const start = Date.now();
      while(true){
        if (window.Tesseract) return true;
        if (Date.now() - start > 8000) throw new Error("LIB_LOAD_TIMEOUT");
        await new Promise(r=>setTimeout(r,50));
      }
    }

    const LS_KEY="lp_catalog_v1_records";
    const CATNO_REGEX=/\b(?:SLPX|LPX|SLPM)\s*[-]?\s*\d{2,6}\b/gi;
    const DISCOGS_PROXY="/api/discogs";

    const state={ view:"home", scanner:{running:false,stream:null,ocrTimer:null,barcodeFound:false,animFrame:null,startWatchdog:null}, preview:null };

    const $=(s)=>document.querySelector(s);
    const views={ home:$("#view-home"), scan:$("#view-scan"), collection:$("#view-collection"), settings:$("#view-settings") };
    const nav={ home:$("#navHome"), collection:$("#navCollection"), settings:$("#navSettings") };

    function setPill(t){ $("#pillStateText").textContent=t; }
    function toast(msg,ms=2200){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.classList.remove("show"),ms); }

    function setView(name){
      state.view=name;
      for(const k in views) views[k].classList.toggle("hidden",k!==name);
      for(const k in nav) nav[k].classList.toggle("active",k===name);
      if(name!=="scan") stopScan();
      if(name==="collection") renderCollection();
    }

    function loadRecords(){ try{ const r=localStorage.getItem(LS_KEY); const a=r?JSON.parse(r):[]; return Array.isArray(a)?a:[] }catch{return []} }
    function saveRecords(a){ localStorage.setItem(LS_KEY,JSON.stringify(a)); }
    function addRecord(rec){ const a=loadRecords(); a.unshift(rec); saveRecords(a); }

    function escapeAttr(s){ return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function escapeText(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function csvEscape(v){ const s=(v??"").toString().replaceAll("\r"," ").replaceAll("\n"," "); return (/[",]/.test(s))?`"${s.replaceAll('"','""')}"`:s; }

    function summarizeRec(rec){
      const parts=[]; if(rec.year) parts.push(rec.year); if(rec.label) parts.push(rec.label);
      if(rec.catno) parts.push("Cat#: "+rec.catno); if(rec.grade) parts.push("Állapot: "+rec.grade);
      return parts.join(" • ") || "—";
    }

    async function proxyFetch(endpoint){
      const url=new URL(DISCOGS_PROXY,location.origin);
      url.searchParams.set("endpoint",endpoint);
      const res=await fetch(url.toString());
      if(!res.ok) throw new Error("Proxy/Discogs hiba ("+res.status+"): "+(await res.text().catch(()=> "")));
      return res.json();
    }
    const discogsSearchByBarcode=(barcode)=>proxyFetch("database/search?"+new URLSearchParams({barcode,type:"release",per_page:"5"}));
    const discogsSearchByCatno=(catno)=>proxyFetch("database/search?"+new URLSearchParams({catno,type:"release",per_page:"5"}));
    const discogsGetRelease=(id)=>proxyFetch("releases/"+encodeURIComponent(id));

    function normalizeRelease(release,fallbackCatno=""){
      const artist=(release.artists||[]).map(a=>a?.name).filter(Boolean).join(", ").replace(/\s+\(\d+\)$/,"") || "";
      const title=release.title||"Ismeretlen cím";
      const year=release.year?String(release.year):"";
      const label=(release.labels||[]).map(l=>l?.name).filter(Boolean).slice(0,2).join(", ");
      const catno=(release.labels||[]).map(l=>l?.catno).filter(Boolean).find(Boolean)||fallbackCatno||"";
      const cover=release.images?.find(i=>i.type==="primary")?.uri||release.images?.[0]?.uri||release.thumb||"";
      return { id:crypto.randomUUID(), discogsReleaseId:release.id||null, artist,title,year,label,catno,grade:"NM",coverUrl:cover,
        createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() };
    }

    async function fetchAndPreview({barcode=null,catno=null}){
      try{
        setPill("Discogs…");
        const search=barcode?await discogsSearchByBarcode(barcode):await discogsSearchByCatno(catno);
        const best=search?.results?.[0];
        if(!best){ toast("Nincs Discogs találat."); setPill("Készen"); return; }
        const release=await discogsGetRelease(best.id);
        const rec=normalizeRelease(release,catno||"");
        $("#catnoInput").value=rec.catno||(catno||"");
        $("#gradeSelect").value="NM";
        state.preview=rec;

        $("#previewCover").innerHTML=rec.coverUrl?`<img alt="Borító" src="${escapeAttr(rec.coverUrl)}">`:"";
        $("#previewTitle").textContent=`${rec.artist} — ${rec.title}`;
        $("#previewDetails").textContent=summarizeRec(rec);
        $("#previewCard").classList.remove("hidden");
        setPill("Előnézet");
      }catch(e){
        console.error(e);
        toast("Discogs hiba: ellenőrizd a /api/discogs proxyt és a Vercel DISCOGS_TOKEN env var-t.");
        setPill("Készen");
      }
    }

// ── NATÍV KAMERA SCANNER (getUserMedia + BarcodeDetector) ──────────────────
    // Megbízhatóbb mint html5-qrcode: nincs könyvtár bug, átlátható hibakezelés.

    function getVideo(){ return document.querySelector("#qr-reader video"); }

    async function stopScan(keepView=false){
      clearTimeout(state.scanner.ocrTimer);
      clearTimeout(state.scanner.startWatchdog);
      cancelAnimationFrame(state.scanner.animFrame);
      state.scanner.animFrame = null;
      // Stream leállítása
      if(state.scanner.stream){
        state.scanner.stream.getTracks().forEach(t=>t.stop());
        state.scanner.stream = null;
      }
      // Video elem takarítás
      const v = getVideo();
      if(v){ v.srcObject = null; }
      state.scanner.running = false;
      if(!keepView && state.view==="scan") setView("home");
      setPill("Készen");
    }

    async function startScan(){
      if(state.scanner.running) return;
      if(state.scanner.stream){ await stopScan(true); }

      setView("scan");
      setPill("Kamera indítása…");
      $("#previewCard").classList.add("hidden");
      state.preview = null;
      $("#foundCode").textContent = "—";
      $("#foundSource").textContent = "—";
      $("#ocrBadge").textContent = "Készenlétben";
      $("#ocrBadge").className = "badge";
      state.scanner.running = true;
      state.scanner.barcodeFound = false;

      // Video elem felépítése
      const container = $("#qr-reader");
      container.innerHTML = "";
      const vid = document.createElement("video");
      vid.setAttribute("playsinline","");
      vid.setAttribute("webkit-playsinline","");
      vid.muted = true;
      vid.autoplay = true;
      vid.style.cssText = "width:100%;height:100%;object-fit:cover;display:block;";
      container.appendChild(vid);

      try{
        // Kamera stream kérése
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal:"environment" }, width:{ideal:1280}, height:{ideal:720} },
          audio: false
        });
        if(!state.scanner.running){ stream.getTracks().forEach(t=>t.stop()); return; }
        state.scanner.stream = stream;
        vid.srcObject = stream;
        await vid.play();

        setPill("Beolvasás");

        // BarcodeDetector (Chrome 83+, Android Chrome, Edge)
        const hasBarcodeDetector = "BarcodeDetector" in window;
        let detector = null;
        if(hasBarcodeDetector){
          detector = new BarcodeDetector({ formats: ["ean_13","ean_8","upc_a","upc_e","code_128","code_39"] });
        }

        // Canvas az OCR-hoz és BarcodeDetector fallback-hoz
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });

        let lastBarcodeScan = 0;

        async function scanLoop(){
          if(!state.scanner.running || state.scanner.barcodeFound) return;
          state.scanner.animFrame = requestAnimationFrame(scanLoop);

          if(vid.readyState < 2) return; // még nem áll készen

          const now = Date.now();

          // BarcodeDetector: 10 fps-nek megfelelő időzítéssel
          if(hasBarcodeDetector && now - lastBarcodeScan > 100){
            lastBarcodeScan = now;
            try{
              const barcodes = await detector.detect(vid);
              for(const bc of barcodes){
                const cleaned = String(bc.rawValue||"").replace(/\s/g,"");
                if(/^\d{13}$/.test(cleaned)){
                  state.scanner.barcodeFound = true;
                  cancelAnimationFrame(state.scanner.animFrame);
                  $("#foundCode").textContent = cleaned;
                  $("#foundSource").textContent = "Vonalkód";
                  $("#ocrBadge").textContent = "Nem szükséges";
                  $("#ocrBadge").className = "badge ok";
                  toast("Vonalkód észlelve: "+cleaned);
                  await stopScan(true);
                  await fetchAndPreview({barcode: cleaned});
                  return;
                }
              }
            }catch(_){}
          }
        }

        scanLoop();
        scheduleOcrFallback();

      }catch(e){
        console.error("Kamera hiba:", e);
        state.scanner.running = false;
        state.scanner.stream = null;
        container.innerHTML = "";
        const msg = String(e?.name || e?.message || "").toLowerCase();
        if(msg.includes("notallowed") || msg.includes("permission") || msg.includes("denied")){
          toast("Kamera hozzáférés megtagadva — engedélyezd a böngészőben!");
        } else if(msg.includes("notfound") || msg.includes("devicenotfound")){
          toast("Nem található kamera ezen az eszközön.");
        } else if(msg.includes("notreadable") || msg.includes("trackstarterror")){
          toast("A kamera foglalt — zárd be a többi appot, majd próbáld újra.");
        } else {
          toast("Kamera hiba: "+(e?.name||e?.message||"ismeretlen"));
        }
        setPill("Hiba");
        setView("home");
      }
    }

    function scheduleOcrFallback(){
      clearTimeout(state.scanner.ocrTimer);
      state.scanner.ocrTimer=setTimeout(async ()=>{
        if(!state.scanner.running || state.scanner.barcodeFound) return;
        $("#ocrBadge").textContent="OCR fut…"; $("#ocrBadge").className="badge gold";
        setPill("OCR…");
        try{
          const catno=await runOcrForCatno();
          if(!catno){
            $("#ocrBadge").textContent="Nincs találat"; $("#ocrBadge").className="badge warn";
            setPill("Beolvasás"); scheduleOcrFallback(); return;
          }
          $("#foundCode").textContent=catno; $("#foundSource").textContent="OCR";
          $("#ocrBadge").textContent="Találat"; $("#ocrBadge").className="badge ok";
          toast("Katalógusszám észlelve: "+catno);
          await stopScan(true);
          await fetchAndPreview({catno});
        }catch(e){
          console.error(e);
          $("#ocrBadge").textContent="OCR hiba"; $("#ocrBadge").className="badge warn";
          setPill("Beolvasás");
        }
      },2600);
    }

    async function runOcrForCatno(){
      const v=getVideo();
      if(!v || v.readyState<2) return null;
      const vw=v.videoWidth, vh=v.videoHeight;
      if(!vw || !vh) return null;
      const crop=Math.floor(Math.min(vw,vh)*0.62);
      const sx=Math.floor((vw-crop)/2), sy=Math.floor((vh-crop)/2);
      const c=document.createElement("canvas"); c.width=crop; c.height=crop;
      const ctx=c.getContext("2d",{willReadFrequently:true});
      ctx.drawImage(v,sx,sy,crop,crop,0,0,crop,crop);
      const r=await Tesseract.recognize(c.toDataURL("image/png"),"eng",{logger:()=>{}});
      const text=(r?.data?.text||"").toUpperCase();
      const m=text.match(CATNO_REGEX);
      return m?.[0]?.replace(/\s+/g," ").trim()||null;
    }

    // stopScan már fentebb definiálva a startScan blokk előtt

    function renderCollection(){
      const all=loadRecords();
      const empty=$("#collectionEmpty");
      const grid=$("#collectionGrid");
      if(!all.length){ empty.classList.remove("hidden"); grid.classList.add("hidden"); grid.innerHTML=""; return; }
      empty.classList.add("hidden"); grid.classList.remove("hidden");
      grid.innerHTML=all.map(rec=>`
        <div class="card item">
          <div class="thumb">${rec.coverUrl?`<img alt="Borító" src="${escapeAttr(rec.coverUrl)}">`:""}</div>
          <div class="t">
            <div class="a">${escapeText(rec.artist||"—")}</div>
            <div class="b">${escapeText(rec.title||"—")}</div>
            <div class="a" style="margin-top:6px">${escapeText(summarizeRec(rec))}</div>
          </div>
        </div>`).join("");
    }

    function toCsv(records){
      const headers=["Előadó","Cím","Év","Kiadó","Katalógusszám","Állapot","DiscogsReleaseId","BorítóURL","Létrehozva","Módosítva"];
      const rows=records.map(r=>[r.artist,r.title,r.year,r.label,r.catno,r.grade,r.discogsReleaseId,r.coverUrl,r.createdAt,r.updatedAt].map(csvEscape).join(","));
      return headers.join(",")+"\n"+rows.join("\n");
    }

    async function exportCsv(){
      const records=loadRecords();
      if(!records.length){ toast("Nincs mit exportálni."); return; }
      const csv=toCsv(records);
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const name=`lp-gyujtemeny-${new Date().toISOString().slice(0,10)}.csv`;
      try{
        if(navigator.canShare && navigator.canShare({files:[new File([blob],name,{type:blob.type})]})){
          await navigator.share({title:"LP Gyűjtemény (CSV)",text:"LP gyűjtemény export CSV formátumban.",files:[new File([blob],name,{type:blob.type})]});
          toast("Megosztás elindítva."); return;
        }
      }catch{}
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast("CSV letöltve.");
    }

    function bindUI(){
      $("#btnStartScan").addEventListener("click", startScan);
      $("#btnGoCollection").addEventListener("click", ()=>setView("collection"));
      $("#btnStopScan").addEventListener("click", ()=>stopScan(false));
      $("#btnRetry").addEventListener("click", ()=>{ stopScan(true).finally(()=>startScan()); });

      $("#btnApproveSave").addEventListener("click", ()=>{
        if(!state.preview) return;
        const grade=$("#gradeSelect").value;
        const catno=($("#catnoInput").value||"").trim();
        addRecord({ ...state.preview, grade, catno });
        toast("Mentve a gyűjteménybe.");
        state.preview=null;
        $("#previewCard").classList.add("hidden");
        setView("collection");
      });
      $("#btnReject").addEventListener("click", ()=>{
        state.preview=null;
        $("#previewCard").classList.add("hidden");
        toast("Előnézet elutasítva.");
      });

      $("#btnExportCsv").addEventListener("click", exportCsv);
      $("#btnClearAll").addEventListener("click", ()=>{
        if(!confirm("Biztosan törlöd az összes mentett lemezt?")) return;
        saveRecords([]); toast("Gyűjtemény törölve."); renderCollection();
      });

      nav.home.addEventListener("click", ()=>setView("home"));
      nav.collection.addEventListener("click", ()=>setView("collection"));
      nav.settings.addEventListener("click", ()=>setView("settings"));

      document.addEventListener("visibilitychange", ()=>{ if(document.hidden) stopScan(true); });
    }

    window.addEventListener("load", async ()=>{
      try{ await waitForLibs(); }
      catch(e){ console.error(e); toast("Nem töltődtek be a könyvtárak (tesseract). Frissíts és próbáld újra."); }
      bindUI();
      renderCollection();
      if("serviceWorker" in navigator){ try{ await navigator.serviceWorker.register("./sw.js"); }catch{} }
    });
  </script>
</body>
</html>

